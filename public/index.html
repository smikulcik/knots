<html>
  <head>
  <style>
    body {
      margin: 0px;
      padding: 0px;
    }
    #myCanvas {
      border: 1px solid #9C98ff;
    }
  </style>
  <script>
    class Mat {
      constructor(rows, cols, data){
        this.rows = rows
        this.cols = cols
        this.data = data
      }
    }
    function dot(a, b){
      return a.x*b.x + a.y*b.y
    }
    function normalize(v){
      const mag = Math.sqrt(v.x*v.x + v.y*v.y)
      return {
        x: v.x/mag,
        y: v.y/mag
      }
    }
    function matMul(a, b){
      const out = new Array(a.rows * b.cols)

      for(let aRow = 0;aRow<a.rows;aRow++){
        for(let bCol = 0; bCol<b.cols; bCol++){
          out[aRow*a.cols+bCol] = 0
          for(let i=0;i<a.cols;i++){
            out[aRow*a.cols+bCol] += a.data[aRow*a.cols+i]*b.data[i*b.cols+bCol]
          }
        }
      }
      return new Mat(a.rows, b.cols, out)
    }
    function project(p, v){
      v = normalize(v)
      const mag = dot(p, v)
      return {
        x: v.x*mag,
        y: v.y*mag
      }
    }
    // console.log('proj', project({x: 3, y: 4}, {x: 3, y: 4}))
    // const x = new Mat(2,2, 
    //   [1,2,
    //    3,4])
    // const y = new Mat(2,2,
    //   [5,6,
    //    7,8])
    // console.log('x', x, y, matMul(x, y))

    function angMagFrom(a, angle, magnitude) {
      return {
        x: a.x + magnitude*Math.cos(angle*Math.PI/180.0),
        y: a.y + magnitude*Math.sin(angle*Math.PI/180.0),
      }
    }
    function circle(context, c, radius, color){
      context.beginPath();
      context.arc(c.x, c.y, radius, 0, 2 * Math.PI, false);
      context.fillStyle = color;
      context.fill();
      // context.lineWidth = 5;
      // context.strokeStyle = '#003300';
      // context.stroke();
    }
    function line(context, s, e, lineWidth, color){
      return bezier(context, s, s, e, e, lineWidth, color)
    }
    function bezier(context, s, c1, c2, e, lineWidth, color){
      context.beginPath()
      context.moveTo(s.x, s.y)
      context.lineWidth = lineWidth
      context.strokeStyle = color
      context.bezierCurveTo(c1.x, c1.y, c2.x, c2.y, e.x, e.y)
      context.stroke()
    }
    const knot = [
      {
        x: 200,
        y: 100,
        a: {
          a: -20, // angle in degrees
          m1: 50, // outbound magnitude
          m2: -100, // inbound magnitude 
          n: {i: 1,x: 'a'}
        },
        b: {
          a: 270, // angle in degrees
          m1: 75, // outbound magnitude
          m2: -50, // inbound magnitude 
          n: {i: 1,x: 'b'}
        },
        top: 'a'
      },
      {
        x: 400,
        y: 100,
        a: {
          a: 20, // angle in degrees
          m1: 100, // outbound magnitude
          m2: -50, // inbound magnitude 
          n: {i: 2,x: 'a'}
        },
        b: {
          a: 90, // angle in degrees
          m1: 50, // outbound magnitude
          m2: -75, // inbound magnitude 
          n: {i: 2,x: 'b'}
        },
        top: 'b'
      },
      {
        x: 300,
        y: 250,
        a: {
          a: 210, // angle in degrees
          m1: 50, // outbound magnitude
          m2: -100, // inbound magnitude 
          n: {i: 0,x: 'b'}
        },
        b: {
          a: 150, // angle in degrees
          m1: 100, // outbound magnitude
          m2: -50, // inbound magnitude 
          n: {i: 0,x: 'a'}
        },
        top: 'a'
      }
    ]
    window.onload = function () {
      var canvas = document.getElementById("canvas")
      var context = canvas.getContext("2d")

      context.fillStyle = "#eeeeee"
      context.strokeStyle = '#000000'
      context.rect(0, 0, 800, 600)
      context.fill()

      let cur = {
        i: 0,
        x: 'a'
      }
      let lineWidth=20
      do {
      
        // start and end
        const start = knot[cur.i]
        const nxt = start[cur.x].n
        const end = knot[nxt.i]

        // shift start/end to be starting after the crossover ends
        const s = angMagFrom(start, start[cur.x].a, lineWidth)
        const e = angMagFrom(end, end[nxt.x].a, -1*lineWidth)

        // control points from angle
        const c1 = angMagFrom(s, start[cur.x].a, start[cur.x].m1)
        const c2 = angMagFrom(e, end[nxt.x].a, end[nxt.x].m2)

        // draw curve
        bezier(context, s, c1, c2, e, lineWidth, '#000000')
        bezier(context, s, c1, c2, e, lineWidth-3, '#ffffff')

        // draw control point lines
        line(context, s, c1, 1, '#008800')
        circle(context, c1, 3, '#008800')
        line(context, e, c2, 1, '#008800')
        circle(context, c2, 3, '#008800')

        cur = knot[cur.i][cur.x].n
      } while (cur.i !== 0 || cur.x !== 'a') // continue until we get to the start

      // draw cross overs on top
      for(const crossover of knot){
        const bottom = crossover.top === 'a' ? 'b' : 'a'
        for(const x of [bottom, crossover.top]){
          const start = angMagFrom(crossover, crossover[x].a, -1*(lineWidth+1)) // give an extra pixel to the top layer
          const end = angMagFrom(crossover, crossover[x].a, (lineWidth+1))
          const borderStart = angMagFrom(crossover, crossover[x].a, -1*(lineWidth))
          const borderEnd = angMagFrom(crossover, crossover[x].a, (lineWidth))

          bezier(context, borderStart, borderStart, borderEnd, borderEnd, lineWidth, '#000000')
          bezier(context, start, start, end, end, lineWidth-3, '#ffffff')
        }
      }
    }
  </script>
  </head>
  <body>
  <canvas id="canvas" width="800" height="600"></canvas>
  </body>
</html>
